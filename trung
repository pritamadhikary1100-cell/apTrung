-- ==================== AUTO HATCH MODULE ====================
-- Loaded from: https://raw.githubusercontent.com/maihoangphi2531/REPO/main/autohatch.luads
-- Requirements: WindUI, global variables from the main script
-- ===========================================================

local Module = {}

-- T·∫Øt to√†n b·ªô log console trong module n√†y
local warn = function(...) end

-- ‚úÖ Fetch required globals from the main script
local WindUI = _G.WindUI
local Window = _G.Window
local Players = game:GetService("Players")
local c = _G.PlayerLocal
local d = _G.UserId
local e = _G.HttpService
local ConfigSystem = _G.ConfigSystem
local Toggles = _G.Toggles
local Options = _G.Options
local bQ = _G.GearPerks  -- Perk data
local bR = _G.ItemsModule  -- Items data

-- ‚úÖ Fetch ReplicatedStorage references
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local ItemsModule = require(Shared:WaitForChild("Items"))
local BuyEggRemote = Shared:WaitForChild("Pets"):WaitForChild("BuyEgg")
local EquipItemRemote = Shared:WaitForChild("Inventory"):WaitForChild("EquipItem")
local HatchRemote = Shared:WaitForChild("Pets"):WaitForChild("Hatch")

-- ‚úÖ Fetch Player references
local PlayerGui = c:WaitForChild("PlayerGui")
local Profile = PlayerGui:WaitForChild("Profile")
local InventoryItems = Profile:WaitForChild("Inventory"):WaitForChild("Items")
local PlayerEquips = ReplicatedStorage:WaitForChild("PlayerEquips"):WaitForChild(c.Name)
local PetEquip = PlayerEquips:WaitForChild("Pet")

-- ==================== GLOBALS ====================
local HatchGlobals = {
    isAutoHatching = false,
    isAutoBuying = false,
    selectedEgg = "",
    purchaseMethod = "Gold", -- "Gold" or "Gems"
    eggsList = {},
    totalEggsBought = 0,
    totalEggsHatched = 0,
    sessionStartTime = 0,
    smartPetKeep = false, -- Smart pet keep toggle
    autoSellPetByTier = false, -- Auto sell pets by tier toggle
    autoSellAllPets = false, -- Auto sell all pets toggle
    petPerkThresholds = {}, -- Perk thresholds for pets (separate from weapons)
    petTierSellList = {true, true, true, true, true}, -- Tiers to sell (1-5)
    totalPetsSold = 0, -- Statistic for total sold pets
    -- Config
    ConfigFile = "AnyaHub_HatchConfig_" .. c.Name .. ".txt"
}

-- ==================== UTILITY FUNCTIONS ====================
local function libNoti(msg, duration)
    WindUI:Notify({
        Title = "Auto Hatch",
        Content = msg,
        Duration = duration or 5
    })
end

local function formatNumber(num)
    if num >= 1000000 then
        return string.format("%.1fM", num / 1000000)
    elseif num >= 1000 then
        return string.format("%.1fK", num / 1000)
    else
        return tostring(num)
    end
end

local function timeElapsed(seconds)
    local hours = math.floor(seconds / 3600)
    local mins = math.floor((seconds % 3600) / 60)
    local secs = seconds % 60
    
    if hours > 0 then
        return string.format("%dh %dm %ds", hours, mins, secs)
    elseif mins > 0 then
        return string.format("%dm %ds", mins, secs)
    else
        return string.format("%ds", secs)
    end
end

-- ==================== EGG FUNCTIONS ====================
-- Get the egg list from the Items module
local function getEggsList()
    local eggs = {}
    
    for itemName, itemData in pairs(ItemsModule) do
        -- Check if the entry is an egg (Type == "Egg" or the name contains "Egg")
        if itemData.Type == "Egg" or string.match(itemName, "Egg") then
            table.insert(eggs, itemName)
        end
    end
    
    table.sort(eggs)
    
    -- Provide a fallback list if no eggs are found
    if #eggs == 0 then
        eggs = {
            "StarterEgg",
            "ForestEgg", 
            "DesertEgg",
            "ArcticEgg",
            "VolcanoEgg",
            "OceanEgg",
            "SpaceEgg",
            "MythicEgg",
            "LegendaryEgg",
            "StarEgg"
        }
    end
    
    return eggs
end

-- Purchase an egg
local function buyEgg(eggName, method)
    if not eggName or eggName == "" then
        return false
    end
    
    local success = pcall(function()
        BuyEggRemote:FireServer(eggName, method or "Gold")
    end)
    
    if success then
        HatchGlobals.totalEggsBought = HatchGlobals.totalEggsBought + 1
    end
    
    return success
end

-- Find all eggs in the inventory
local function findEggsInInventory()
    local eggs = {}
    
    for _, item in ipairs(InventoryItems:GetChildren()) do
        -- Ensure the item is actually an egg
        local itemName = item.Name
        if string.match(itemName, "Egg") or (ItemsModule[itemName] and ItemsModule[itemName].Type == "Egg") then
            table.insert(eggs, item)
        end
    end
    
    return eggs
end

-- Equip an egg into the Pet slot
local function equipEgg(eggItem)
    if not eggItem or not eggItem.Parent then
        return false
    end
    
    local success = pcall(function()
        EquipItemRemote:FireServer(eggItem, PetEquip)
    end)
    
    return success
end

-- Hatch the equipped egg
local function hatchEquippedEgg()
    local success = pcall(function()
        -- Use the player's position when hatching
        local character = c.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            local position = character.HumanoidRootPart.Position
            HatchRemote:FireServer(position)
        end
    end)
    
    if success then
        HatchGlobals.totalEggsHatched = HatchGlobals.totalEggsHatched + 1
    end
    
    return success
end

-- Hatch a single egg: Equip -> Hatch -> Wait
local function hatchSingleEgg(eggItem)
    -- Step 1: Equip the egg
    if not equipEgg(eggItem) then
        return false
    end
    
    task.wait(0.2) -- Wait for equip to finish
    
    -- Step 2: Hatch the equipped egg
    local success = hatchEquippedEgg()
    
    task.wait(1) -- Wait for the hatch animation
    
    return success
end

-- Hatch every egg in the inventory
local function hatchAllEggs()
    local eggs = findEggsInInventory()
    local hatchedCount = 0
    
    for _, egg in ipairs(eggs) do
        if hatchSingleEgg(egg) then
            hatchedCount = hatchedCount + 1
            task.wait(2) -- Small delay between hatch attempts
        end
    end
    
    return hatchedCount
end

-- ==================== SMART PET KEEP ====================
-- Fetch pet perk list (matching in-game logic: PetOnly=true OR universal)
local function getPetPerksList()
    local petPerks = {}
    
    for perkKey, perkData in pairs(bQ) do
        -- ‚úÖ Match in-game logic: RollForPerk line 268-277
        -- Condition: (no WeaponOnly and no ArmorOnly) OR PetOnly
        local canAppearOnPet = (not perkData.WeaponOnly and not perkData.ArmorOnly) or perkData.PetOnly
        
        if canAppearOnPet and not perkData.Disabled then
            -- Prefer PetStatRange; fall back to StatRange
            local statRange = perkData.PetStatRange or perkData.StatRange
            
            if statRange then
                table.insert(petPerks, {
                    key = perkKey,
                    name = perkData.DisplayName,
                    desc = perkData.DisplayDesc,
                    min = statRange[1] * 100,
                    max = statRange[2] * 100
                })
            end
        end
    end
    
    table.sort(petPerks, function(a, b) return a.name < b.name end)
    return petPerks
end

-- Check if a pet meets perk thresholds (same logic as weapons ‚Äì only one perk is needed)
local function checkPetPerks(petItem)
    local hasValidPerk = false
    local bestPerkInfo = nil
    local shouldKeepPet = false
    
    -- ‚úÖ Scan every child to detect Perk, Perk1, Perk2, Perk3
    for _, child in ipairs(petItem:GetChildren()) do
        -- Only handle StringValue instances that contain a PerkValue child
        if child:IsA("StringValue") and child:FindFirstChild("PerkValue") then
            local perkName = child.Value
            local perkValue = child.PerkValue.Value
            
            -- Fetch perk data
            local perkData = bQ[perkName]
            
            -- ‚úÖ Validate that the perk can appear on pets
            -- Same as getPetPerksList: (no WeaponOnly and no ArmorOnly) OR PetOnly
            if perkData then
                local canAppearOnPet = (not perkData.WeaponOnly and not perkData.ArmorOnly) or perkData.PetOnly
                local statRange = perkData.PetStatRange or perkData.StatRange
                
                if canAppearOnPet and statRange then
                    hasValidPerk = true
                    
                    -- Read the threshold from HatchGlobals.petPerkThresholds
                    -- ‚úÖ If missing, default to 999% to force a sell
                    local threshold = HatchGlobals.petPerkThresholds[perkName]
                    if not threshold then
                        threshold = 999 -- Ng∆∞·ª°ng cao ƒë·ªÉ ch·∫Øc ch·∫Øn B√ÅN
                    else
                        -- ‚úÖ Convert strings back to numbers (config stores strings)
                        threshold = tonumber(threshold) or 999
                    end
                    
                    local perkPercent = math.round(perkValue * 100)
                    
                    -- ‚úÖ Keep the pet if at least one perk meets the threshold
                    local meetsThreshold = perkPercent >= threshold
                    
                    if meetsThreshold and not shouldKeepPet then
                        shouldKeepPet = true
                    end
                    
                    -- Track the best perk for display (first meeting threshold or highest value)
                    if not bestPerkInfo or meetsThreshold or (not shouldKeepPet and perkPercent > bestPerkInfo.value) then
                        bestPerkInfo = {
                            name = perkData.DisplayName,
                            value = perkPercent,
                            threshold = threshold,
                            meets = meetsThreshold
                        }
                    end
                end
            end
        end
    end
    
    -- No valid perks -> sell the pet
    if not hasValidPerk then
        return false, {
            name = "No Valid Perk",
            value = 0,
            threshold = 0
        }
    end
    
    return shouldKeepPet, bestPerkInfo
end

-- Sell pet
local function sellPet(petItem)
    if not petItem then
        return false
    end
    
    -- ‚úÖ D√πng chung remote SellItems nh∆∞ v≈© kh√≠
    local SellRemote = ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Drops"):WaitForChild("SellItems")
    local success = pcall(function()
        SellRemote:InvokeServer({petItem})
    end)
    
    if success then
        HatchGlobals.totalPetsSold = HatchGlobals.totalPetsSold + 1
    end
    
    return success
end

-- Get the pet tier
local function getPetTier(petItem)
    if not petItem or not petItem:FindFirstChild("Variant") then
        return nil
    end
    
    local petName = petItem.Name
    local variantValue = petItem.Variant.Value
    
    -- Grab data from ItemsModule
    local itemData = ItemsModule[petName]
    if not itemData or itemData.Type ~= "Pet" or not itemData.Variants then
        return nil
    end
    
    -- Match variant entry
    for _, variant in ipairs(itemData.Variants) do
        -- variant = {variantId, name, weight, tier, skill}
        if variant[1] == variantValue then
            return variant[4] -- Tier stored at index 4
        end
    end
    
    return nil
end

-- Determine if a pet should be sold based on tier
local function shouldSellPetByTier(petItem)
    local tier = getPetTier(petItem)
    if not tier then
        return false -- Unknown tier, skip selling
    end
    
    -- Ki·ªÉm tra xem tier n√†y c√≥ trong danh s√°ch sell kh√¥ng
    return HatchGlobals.petTierSellList[tier] == true
end

-- Fetch every pet in the inventory
local function getAllPetsInInventory()
    local pets = {}
    
    for _, item in ipairs(InventoryItems:GetChildren()) do
        if item:IsA("Folder") then
            local itemData = bR[item.Name]
            if itemData and itemData.Type == "Pet" then
                table.insert(pets, item)
            end
        end
    end
    
    return pets
end

-- Sell all pets in the inventory
local function sellAllPets()
    local pets = getAllPetsInInventory()
    local soldCount = 0
    
    if #pets == 0 then
        return 0
    end
    
    -- Gather every pet into a single array
    local petsToSell = {}
    for _, pet in ipairs(pets) do
        table.insert(petsToSell, pet)
    end
    
    -- Call the remote once to sell everything
    if #petsToSell > 0 then
        -- ‚úÖ Use the same SellItems remote as weapons
        local SellRemote = ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Drops"):WaitForChild("SellItems")
        local success = pcall(function()
            SellRemote:InvokeServer(petsToSell)
        end)
        
        if success then
            soldCount = #petsToSell
            HatchGlobals.totalPetsSold = HatchGlobals.totalPetsSold + soldCount
        end
    end
    
    return soldCount
end

-- ==================== AUTO FUNCTIONS ====================
local function startAutoBuy()
    if HatchGlobals.isAutoBuying then
        return
    end
    
    if not HatchGlobals.selectedEgg or HatchGlobals.selectedEgg == "" then
        return
    end
    
    HatchGlobals.isAutoBuying = true
    if HatchGlobals.sessionStartTime == 0 then
        HatchGlobals.sessionStartTime = tick()
    end
    
    
    task.spawn(function()
        while true do
            -- ‚úÖ Re-check toggle state before each action
            local autoBuyEnabled = false
            if _G.Toggles and _G.Toggles.AutoBuyEgg then
                autoBuyEnabled = _G.Toggles.AutoBuyEgg.Value
            end
            
            -- Stop immediately if toggles or globals disable auto buy
            if not autoBuyEnabled or not HatchGlobals.isAutoBuying then
                if HatchGlobals.isAutoBuying then
                    HatchGlobals.isAutoBuying = false
                end
                break
            end
            
            local success = buyEgg(HatchGlobals.selectedEgg, HatchGlobals.purchaseMethod)
            
            -- Short wait interval with frequent toggle checks
            local waitTime = success and 0.5 or 1
            local waited = 0
            while waited < waitTime do
                -- Check toggles every 0.1 seconds during the wait
                task.wait(0.1)
                waited = waited + 0.1
                
                -- Abort immediately if disabled mid-wait
                local stillEnabled = _G.Toggles and _G.Toggles.AutoBuyEgg and _G.Toggles.AutoBuyEgg.Value
                if not stillEnabled or not HatchGlobals.isAutoBuying then
                    HatchGlobals.isAutoBuying = false
                    return
                end
            end
        end
    end)
end

local function startAutoHatch()
    if HatchGlobals.isAutoHatching then
        return
    end
    
    HatchGlobals.isAutoHatching = true
    if HatchGlobals.sessionStartTime == 0 then
        HatchGlobals.sessionStartTime = tick()
    end
    
    libNoti("‚úÖ Auto Hatch started", 3)
    
    task.spawn(function()
        while true do
            -- ‚úÖ Re-check toggle state before each action
            local autoHatchEnabled = false
            if _G.Toggles and _G.Toggles.AutoHatchEgg then
                autoHatchEnabled = _G.Toggles.AutoHatchEgg.Value
            end
            
            -- Stop immediately if toggles or globals disable auto hatch
            if not autoHatchEnabled or not HatchGlobals.isAutoHatching then
                if HatchGlobals.isAutoHatching then
                    HatchGlobals.isAutoHatching = false
                end
                break
            end
            
            local hatchedCount = hatchAllEggs()
            
            -- Short wait interval with frequent toggle checks
            local waitTime = hatchedCount == 0 and 2 or 0.5
            local waited = 0
            while waited < waitTime do
                -- Check toggles every 0.1 seconds during the wait
                task.wait(0.1)
                waited = waited + 0.1
                
                -- Abort immediately if disabled mid-wait
                local stillEnabled = _G.Toggles and _G.Toggles.AutoHatchEgg and _G.Toggles.AutoHatchEgg.Value
                if not stillEnabled or not HatchGlobals.isAutoHatching then
                    HatchGlobals.isAutoHatching = false
                    return
                end
            end
        end
    end)
end

-- ==================== CONFIG FUNCTIONS ====================
local function saveHatchConfig()
    if not writefile then return end
    
    -- Only save account-specific stats (petPerkThresholds are stored through ConfigSystem)
    local data = {
        totalEggsBought = HatchGlobals.totalEggsBought,
        totalEggsHatched = HatchGlobals.totalEggsHatched
    }
    
    pcall(function()
        writefile(HatchGlobals.ConfigFile, e:JSONEncode(data))
    end)
    
    -- log removed
end

local function loadHatchConfig()
    if not (isfile and readfile and isfile(HatchGlobals.ConfigFile)) then
        return false
    end
    
    local success = pcall(function()
        local data = e:JSONDecode(readfile(HatchGlobals.ConfigFile))
        
        -- Only load account-specific stats
        HatchGlobals.totalEggsBought = data.totalEggsBought or 0
        HatchGlobals.totalEggsHatched = data.totalEggsHatched or 0
    end)
    
    if success then
        -- log removed
    end
    
    return success
end

-- ==================== UI CREATION ====================
local function createAutoHatchTab()
    local TabHatch = Window:Tab({
        Title = "Auto Hatch",
        Icon = "egg",
        Locked = false
    })
    
    TabHatch:Section({ Title = "ü•ö Auto Egg System" })

    TabHatch:Divider({ Text = "Egg Selection" })

    -- Fetch egg list
    HatchGlobals.eggsList = getEggsList()
    
    -- Dropdown ch·ªçn egg
    local EggDropdown = TabHatch:Dropdown({
        Title = "üìã Select Egg",
        Description = "Choose which egg to purchase",
        Values = HatchGlobals.eggsList,
        Multi = false,
        Default = HatchGlobals.selectedEgg ~= "" and {HatchGlobals.selectedEgg} or nil,
        Callback = function(selected)
            -- WindUI tr·∫£ v·ªÅ table v·ªõi 1 ph·∫ßn t·ª≠ khi Multi = false
            local eggName = type(selected) == "table" and selected[1] or selected
            if eggName and eggName ~= "" then
                HatchGlobals.selectedEgg = eggName
                HatchGlobals.purchaseMethod = "Gold" -- Always use Gold
                -- Do not call saveHatchConfig() because selectedEgg is persisted via ConfigSystem
                libNoti("‚úÖ Selected: " .. eggName, 2)
            end
        end
    })
    ConfigSystem.registerUIElement("selectedEgg", EggDropdown)
    
    TabHatch:Divider({ Text = "Auto Settings" })

    -- Auto buy toggle
    local AutoBuyToggle = TabHatch:Toggle({
        Title = "üõí Auto Buy Egg",
        Description = "Automatically purchase the selected egg",
        Default = false,
        Callback = function(state)
            -- ‚úÖ Update via Toggles wrapper so ConfigSystem captures it
            if _G.Toggles and _G.Toggles.AutoBuyEgg then
                _G.Toggles.AutoBuyEgg:SetValue(state)
            end
            
            if state then
                startAutoBuy()
            else
                HatchGlobals.isAutoBuying = false
            end
        end
    })
    ConfigSystem.registerUIElement("AutoBuyEgg", AutoBuyToggle)
    
    -- Auto hatch toggle
    local AutoHatchToggle = TabHatch:Toggle({
        Title = "üê£ Auto Hatch Egg",
        Description = "Automatically hatch every egg in your inventory",
        Default = false,
        Callback = function(state)
            -- ‚úÖ Update via Toggles wrapper so ConfigSystem captures it
            if _G.Toggles and _G.Toggles.AutoHatchEgg then
                _G.Toggles.AutoHatchEgg:SetValue(state)
            end
            
            if state then
                startAutoHatch()
            else
                HatchGlobals.isAutoHatching = false
            end
        end
    })
    ConfigSystem.registerUIElement("AutoHatchEgg", AutoHatchToggle)
    
    TabHatch:Divider({ Text = "Smart Pet Keep" })

    -- Smart Pet Keep Toggle
    local SmartPetKeepToggle = TabHatch:Toggle({
        Title = "üéØ Smart Pet Keep",
        Description = "Automatically keep pets whose perks meet thresholds",
        Default = false,
        Callback = function(state)
            -- ‚úÖ Update via Toggles wrapper so ConfigSystem captures it
            if _G.Toggles and _G.Toggles.SmartPetKeep then
                _G.Toggles.SmartPetKeep:SetValue(state)
            end
            HatchGlobals.smartPetKeep = state
        end
    })
    ConfigSystem.registerUIElement("SmartPetKeep", SmartPetKeepToggle)
    
    -- ‚úÖ AUTO SELL PET BY TIER
    TabHatch:Divider({ Text = "Auto Sell by Tier" })
    
    local AutoSellPetByTierToggle = TabHatch:Toggle({
        Title = "üóëÔ∏è Auto Sell Pet by Tier",
        Description = "Automatically sell pets for the selected tiers",
        Default = false,
        Callback = function(state)
            if _G.Toggles and _G.Toggles.AutoSellPetByTier then
                _G.Toggles.AutoSellPetByTier:SetValue(state)
            end
            HatchGlobals.autoSellPetByTier = state
        end
    })
    ConfigSystem.registerUIElement("AutoSellPetByTier", AutoSellPetByTierToggle)
    
    -- Tier checkboxes (same idea as weapon tiers)
    local tierNames = {"Tier 1", "Tier 2", "Tier 3", "Tier 4", "Tier 5"}
    local tierToggles = {}
    
    for tier = 1, 5 do
        local tierToggle = TabHatch:Toggle({
            Title = "üíé " .. tierNames[tier],
            Description = "Sell pets from " .. tierNames[tier],
            Default = true, -- Sell every tier by default
            Callback = function(state)
                -- ‚úÖ Update via Toggles wrapper
                if _G.Toggles and _G.Toggles["PetTierSell_" .. tier] then
                    _G.Toggles["PetTierSell_" .. tier]:SetValue(state)
                end
                HatchGlobals.petTierSellList[tier] = state
            end
        })
        tierToggles[tier] = tierToggle
        ConfigSystem.registerUIElement("PetTierSell_" .. tier, tierToggle)
    end
    
    TabHatch:Divider({ Text = "Smart Pet Keep Thresholds" })
    
    -- ‚úÖ Create a slider for every pet perk
    local petPerks = getPetPerksList()
    for _, perk in ipairs(petPerks) do
        -- Initialize default value
        if not HatchGlobals.petPerkThresholds[perk.key] then
            HatchGlobals.petPerkThresholds[perk.key] = math.round(perk.min)
        end
        
        local slider = TabHatch:Slider({
            Title = perk.name,
            Description = perk.desc .. string.format(" (Range: %.1f%% - %.1f%%)", perk.min, perk.max),
            Step = 1,
            Value = {
                Min = math.round(perk.min),
                Max = math.round(perk.max),
                Default = HatchGlobals.petPerkThresholds[perk.key]
            },
            Callback = function(value)
                HatchGlobals.petPerkThresholds[perk.key] = value
            end
        })
        -- ‚úÖ Register slider with prefix "PetPerk_" to avoid clashing with weapon perks
        ConfigSystem.registerUIElement("PetPerk_" .. perk.key, slider)
    end
    
    -- ‚úÖ AUTO SELL PET ON HATCH (Smart Pet Keep listener)
    InventoryItems.ChildAdded:Connect(function(item)
        task.wait(0.1) -- Wait for the item to finish replicating
        
        -- ‚úÖ Check toggles before doing any work
        local smartPetKeepEnabled = _G.Toggles and _G.Toggles.SmartPetKeep and _G.Toggles.SmartPetKeep.Value or false
        local autoSellByTierEnabled = _G.Toggles and _G.Toggles.AutoSellPetByTier and _G.Toggles.AutoSellPetByTier.Value or false
        local autoSellAllEnabled = _G.Toggles and _G.Toggles.AutoSellAllPets and _G.Toggles.AutoSellAllPets.Value or false
        
        -- If everything is off, skip immediately
        if not smartPetKeepEnabled and not autoSellByTierEnabled and not autoSellAllEnabled then
            return
        end
        
        -- Ensure the item is actually a pet
        local itemData = bR[item.Name]
        if not itemData or itemData.Type ~= "Pet" then
            return
        end
        
        -- ‚úÖ PRIORITY 0: Auto Sell All Pets (ignore every filter)
        if autoSellAllEnabled then
            if sellPet(item) then
                -- No notification per pet to avoid spam
            end
            return
        end
        
        -- Determine pet tier
        local petTier = getPetTier(item)
        
        -- ‚úÖ PRIORITY 1: Smart Pet Keep only applies to Tier 5 first
        if smartPetKeepEnabled and petTier == 5 then
            local shouldKeep, perkInfo = checkPetPerks(item)
            
            if shouldKeep then
                -- Tier 5 pet meets the threshold -> keep it
                libNoti(string.format("‚úÖ Kept (T5): %s | %s: %.1f%% ‚â• %.1f%%", 
                    itemData.DisplayKey or item.Name,
                    perkInfo.name,
                    perkInfo.value,
                    perkInfo.threshold
                ), 2)
                return -- Already kept, no need to check tier filters
            end
            -- If Tier 5 fails the threshold, continue to tier filters
        end
        
        -- ‚úÖ PRIORITY 2: Auto Sell by Tier
        if autoSellByTierEnabled then
            if shouldSellPetByTier(item) then
                if sellPet(item) then
                    libNoti(string.format("üí∞ Sold (Tier %d): %s", petTier or 0, itemData.DisplayKey or item.Name), 1.5)
                end
                return -- Already sold
            end
        end
        
        -- ‚úÖ PRIORITY 3: Smart Pet Keep for other tiers if Auto Sell by Tier skipped
        if smartPetKeepEnabled then
            local shouldKeep, perkInfo = checkPetPerks(item)
            if not shouldKeep then
                if sellPet(item) then
                    libNoti(string.format("üí∞ Sold (Perk): %s | %s: %.1f%% < %.1f%%", 
                        itemData.DisplayKey or item.Name,
                        perkInfo.name,
                        perkInfo.value,
                        perkInfo.threshold
                    ), 2)
                end
            end
        end
    end)
    
    TabHatch:Divider({ Text = "Manual Actions" })
    
    -- Toggle Auto Sell All Pets
    local AutoSellAllPetsToggle = TabHatch:Toggle({
        Title = "üóëÔ∏è Auto Sell All Pets",
        Description = "Automatically sell every pet (ignores all filters)",
        Default = false,
        Callback = function(state)
            if _G.Toggles and _G.Toggles.AutoSellAllPets then
                _G.Toggles.AutoSellAllPets:SetValue(state)
            end
            HatchGlobals.autoSellAllPets = state
           
        end
    })
    ConfigSystem.registerUIElement("AutoSellAllPets", AutoSellAllPetsToggle)
    
    -- Button Sell All Pets
    TabHatch:Button({
        Title = "üóëÔ∏è Sell All Pets",
        Description = "Sell every pet in your inventory (double click)",
        Callback = function()
            local count = sellAllPets()
            if count > 0 then
                libNoti(string.format("üí∞ Sold %d pets!", count), 3)
            else
                libNoti("‚ö†Ô∏è No pets in your inventory", 3)
            end
        end
    })
    
    TabHatch:Divider({ Text = "Other Actions" })
    
    -- Manual buy button
    TabHatch:Button({
        Title = "üõí Buy 1 Egg",
        Description = "Purchase a single egg manually",
        Callback = function()
            if not HatchGlobals.selectedEgg or HatchGlobals.selectedEgg == "" then
                return
            end
            
            local success = buyEgg(HatchGlobals.selectedEgg, HatchGlobals.purchaseMethod)
            if success then
                libNoti("‚úÖ Purchased 1 " .. HatchGlobals.selectedEgg, 2)
            else
                libNoti("‚ùå Unable to buy the egg!", 3)
            end
        end
    })
    
    -- Hatch all button
    TabHatch:Button({
        Title = "üê£ Hatch All Eggs",
        Description = "Hatch every egg in your inventory (double click)",
        Callback = function()
            local count = hatchAllEggs()
            if count > 0 then
                libNoti("‚úÖ Hatched " .. count .. " eggs", 3)
            else
                libNoti("‚ö†Ô∏è No eggs in your inventory", 3)
            end
        end
    })
    
    -- Button reset stats
    TabHatch:Button({
        Title = "üîÑ Reset Statistics",
        Description = "Reset session statistics",
        Callback = function()
            HatchGlobals.totalEggsBought = 0
            HatchGlobals.totalEggsHatched = 0
            HatchGlobals.sessionStartTime = tick()
            saveHatchConfig()
            libNoti("‚úÖ Statistics have been reset", 2)
        end
    })
    
    TabHatch:Divider({ Text = "Statistics" })
    
    -- Statistics paragraphs
    local StatsPara1 = TabHatch:Paragraph({
        Title = "üìä Session Stats",
        Description = "Loading..."
    })
    
    local StatsPara2 = TabHatch:Paragraph({
        Title = "ü•ö Eggs in Inventory",
        Description = "Loading..."
    })
    
    -- Update stats task
    task.spawn(function()
        while true do
            local elapsed = tick() - HatchGlobals.sessionStartTime
            local stats = string.format(
                "‚è±Ô∏è Time: %s\n" ..
                "üõí Purchased: %s eggs\n" ..
                "üê£ Hatched: %s eggs\n" ..
                "üí∞ Sold: %s pets",
                timeElapsed(math.floor(elapsed)),
                formatNumber(HatchGlobals.totalEggsBought),
                formatNumber(HatchGlobals.totalEggsHatched),
                formatNumber(HatchGlobals.totalPetsSold)
            )
            
            StatsPara1:SetDesc(stats)
            
            local eggsInInv = #findEggsInInventory()
            StatsPara2:SetDesc(string.format("%d eggs", eggsInInv))
            
            task.wait(1)
        end
    end)
    
    -- Load config
    loadHatchConfig()
end

-- ==================== INIT MODULE ====================
function Module:Init()
    -- Load per-account stats first
    loadHatchConfig()
    
    -- Build the UI
    createAutoHatchTab()
    
    -- ‚úÖ After creating the UI, auto-load config and sync UI state
    task.spawn(function()
        task.wait(0.5) -- Wait for the UI to render
        
        -- log removed
        
        -- Fetch current config from ConfigSystem
        local currentConfig = nil
        if ConfigSystem.selectedConfig and ConfigSystem.selectedConfig ~= "" then
            local configPath = ConfigSystem.ConfigFolder .. "/" .. ConfigSystem.selectedConfig .. ".txt"
            if isfile and readfile and isfile(configPath) then
                local success, data = pcall(function()
                    return e:JSONDecode(readfile(configPath))
                end)
                if success and data then
                    currentConfig = data
                end
            end
        end
        
        -- If the config exists, load and update UI
        if currentConfig and currentConfig.HatchGlobals then
            
            -- Load selectedEgg
            if currentConfig.HatchGlobals.selectedEgg then
                HatchGlobals.selectedEgg = currentConfig.HatchGlobals.selectedEgg
                
                -- Update dropdown
                local dropdown = ConfigSystem.UIElements["selectedEgg"]
                if dropdown and dropdown.SetValue then
                    pcall(function()
                        dropdown:SetValue({HatchGlobals.selectedEgg})
                    end)
                end
            end
            
            -- Load petPerkThresholds
            if currentConfig.HatchGlobals.petPerkThresholds then
                for key, value in pairs(currentConfig.HatchGlobals.petPerkThresholds) do
                    local numValue = tonumber(value) or value
                    
                    -- Strip the "PetPerk_" prefix when storing in HatchGlobals
                    local perkKey = key
                    if string.sub(key, 1, 8) == "PetPerk_" then
                        perkKey = string.sub(key, 9)
                    end
                    
                    HatchGlobals.petPerkThresholds[perkKey] = numValue
                    
                    -- Update slider
                    local sliderKey = "PetPerk_" .. perkKey
                    local slider = ConfigSystem.UIElements[sliderKey]
                    if slider then
                        local success, err = pcall(function()
                            -- ‚úÖ WindUI sliders expose :Set(value)
                            if slider.Set and type(slider.Set) == "function" then
                                slider:Set(numValue)
                            else
                                warn(string.format("‚ö†Ô∏è Slider %s lacks :Set()", sliderKey))
                            end
                        end)
                        
                        if not success then
                            warn(string.format("‚ùå Error updating slider %s: %s", sliderKey, tostring(err)))
                        end
                    else
                        warn(string.format("‚ö†Ô∏è Slider not found: %s", sliderKey))
                    end
                end
            end
        else
            -- log removed
        end
    end)
    
    -- Hook v√†o ConfigSystem ƒë·ªÉ save/load selectedEgg (chung cho t·∫•t c·∫£ acc)
    local originalGetConfigData = ConfigSystem.getConfigData
    ConfigSystem.getConfigData = function()
        local data = originalGetConfigData()
        -- L∆∞u selectedEgg + petPerkThresholds v√†o config chung
        -- ‚úÖ Chuy·ªÉn ƒë·ªïi t·ª´ petPerkThresholds (kh√¥ng prefix) sang PetPerk_ (c√≥ prefix)
        local petPerkConfig = {}
        for perkKey, value in pairs(HatchGlobals.petPerkThresholds) do
            petPerkConfig["PetPerk_" .. perkKey] = value
        end
        
        data.HatchGlobals = {
            selectedEgg = HatchGlobals.selectedEgg,
            petPerkThresholds = petPerkConfig, -- L∆∞u v·ªõi prefix
            petTierSellList = HatchGlobals.petTierSellList,
            autoSellAllPets = HatchGlobals.autoSellAllPets
        }
        return data
    end
    
    -- Hook v√†o loadConfigData ƒë·ªÉ load selectedEgg v√† update UI
    local originalLoadConfigData = ConfigSystem.loadConfigData
    ConfigSystem.loadConfigData = function(data)
        -- ‚úÖ G·ªåI ORIGINAL TR∆Ø·ªöC
        originalLoadConfigData(data)
        
        -- log removed
        
        -- Load selectedEgg + petPerkThresholds t·ª´ config
        if data and data.HatchGlobals then
            -- log removed
            
            if data.HatchGlobals.selectedEgg then
                HatchGlobals.selectedEgg = data.HatchGlobals.selectedEgg
                -- log removed
            end
            
            -- ‚úÖ Load Pet Perk Thresholds t·ª´ config
            if data.HatchGlobals.petPerkThresholds then
                for key, value in pairs(data.HatchGlobals.petPerkThresholds) do
                    -- ‚úÖ CONVERT STRING SANG NUMBER n·∫øu c·∫ßn
                    local numValue = tonumber(value) or value
                    
                    -- ‚úÖ Lo·∫°i b·ªè prefix "PetPerk_" khi l∆∞u v√†o HatchGlobals
                    local perkKey = key
                    if string.sub(key, 1, 8) == "PetPerk_" then
                        perkKey = string.sub(key, 9) -- C·∫Øt b·ªè 8 k√Ω t·ª± ƒë·∫ßu ("PetPerk_")
                    end
                    
                    HatchGlobals.petPerkThresholds[perkKey] = numValue
                    -- log removed
                end
                -- log removed
            end
            
            -- ‚úÖ Load Pet Tier Sell List t·ª´ config
            if data.HatchGlobals.petTierSellList then
                HatchGlobals.petTierSellList = data.HatchGlobals.petTierSellList
                -- log removed
            end
            
            -- ‚úÖ Load Auto Sell All Pets t·ª´ config
            if data.HatchGlobals.autoSellAllPets ~= nil then
                HatchGlobals.autoSellAllPets = data.HatchGlobals.autoSellAllPets
                -- log removed
            end
            
            -- ‚úÖ Update UI sau khi load (delay ƒë·ªÉ UI ƒë√£ render xong)
            task.spawn(function()
                -- ‚úÖ ƒê·ª¢I UI ELEMENTS ƒê∆Ø·ª¢C ƒêƒÇNG K√ù (t·ªëi ƒëa 10s)
                local maxWait = 10
                local waited = 0
                local uiElementsReady = false
                
                while waited < maxWait do
                    -- Ki·ªÉm tra xem ƒë√£ c√≥ b·∫•t k·ª≥ UI element n√†o ƒë∆∞·ª£c ƒëƒÉng k√Ω ch∆∞a
                    local totalElements = 0
                    for _ in pairs(ConfigSystem.UIElements) do
                        totalElements = totalElements + 1
                    end
                    
                    -- N·∫øu c√≥ √≠t nh·∫•t 3 elements (selectedEgg + 2 toggles t·ªëi thi·ªÉu), coi nh∆∞ ready
                    if totalElements >= 3 then
                        -- log removed
                        uiElementsReady = true
                        break
                    end
                    
                    task.wait(0.5)
                    waited = waited + 0.5
                    -- log removed
                end
                
                if not uiElementsReady then
                    -- log removed
                    return
                end
                
                task.wait(0.5) -- Delay th√™m ch√∫t ƒë·ªÉ ch·∫Øc ch·∫Øn
                
                -- log removed
                
                -- log removed
                
                -- Update dropdown
                local dropdown = ConfigSystem.UIElements["selectedEgg"]
                if dropdown and HatchGlobals.selectedEgg ~= "" then
                    pcall(function()
                        dropdown.Value = {HatchGlobals.selectedEgg}
                        -- ‚ùå KH√îNG g·ªçi callback v√¨ c√≥ th·ªÉ g√¢y l·ªói
                        -- log removed
                    end)
                else
                    -- log removed
                end
                
                -- Update sliders
                -- log removed
                
                local slidersUpdated = 0
                local slidersNotFound = 0
                
                for perkKey, value in pairs(HatchGlobals.petPerkThresholds) do
                    -- ‚úÖ T√åM SLIDER v·ªõi prefix "PetPerk_"
                    local sliderKey = "PetPerk_" .. perkKey
                    local slider = ConfigSystem.UIElements[sliderKey]
                    
                    if slider then
                        local success, err = pcall(function()
                            local numValue = tonumber(value)
                            if not numValue then
                                -- log removed
                                return
                            end
                            
                            -- ‚úÖ WindUI slider d√πng method :Set(value)
                            if slider.Set and type(slider.Set) == "function" then
                                slider:Set(numValue)
                                slidersUpdated = slidersUpdated + 1
                                -- log removed
                            else
                                -- log removed
                            end
                        end)
                        
                        if not success then
                            slidersNotFound = slidersNotFound + 1
                            -- log removed
                        end
                    else
                        slidersNotFound = slidersNotFound + 1
                        -- log removed
                    end
                end
                
                -- log removed
                
                -- Update toggles
                local autoBuyState = _G.ToggleStates.AutoBuyEgg
                local autoHatchState = _G.ToggleStates.AutoHatchEgg
                local smartPetKeepState = _G.ToggleStates.SmartPetKeep
                local autoSellPetByTierState = _G.ToggleStates.AutoSellPetByTier
                local autoSellAllPetsState = _G.ToggleStates.AutoSellAllPets
                
                local autoBuyToggle = ConfigSystem.UIElements["AutoBuyEgg"]
                if autoBuyToggle then
                    pcall(function()
                        local state = autoBuyState or false
                        autoBuyToggle.Value = state
                        -- ‚ùå KH√îNG g·ªçi callback v√¨ c√≥ th·ªÉ g√¢y l·ªói
                        -- log removed
                    end)
                end
                
                local autoHatchToggle = ConfigSystem.UIElements["AutoHatchEgg"]
                if autoHatchToggle then
                    pcall(function()
                        local state = autoHatchState or false
                        autoHatchToggle.Value = state
                        -- log removed
                    end)
                end
                
                local smartPetKeepToggle = ConfigSystem.UIElements["SmartPetKeep"]
                if smartPetKeepToggle then
                    pcall(function()
                        local state = smartPetKeepState or false
                        smartPetKeepToggle.Value = state
                        HatchGlobals.smartPetKeep = state
                        -- log removed
                    end)
                end
                
                local autoSellPetByTierToggle = ConfigSystem.UIElements["AutoSellPetByTier"]
                if autoSellPetByTierToggle then
                    pcall(function()
                        local state = autoSellPetByTierState or false
                        autoSellPetByTierToggle.Value = state
                        HatchGlobals.autoSellPetByTier = state
                        -- log removed
                    end)
                end
                
                local autoSellAllPetsToggle = ConfigSystem.UIElements["AutoSellAllPets"]
                if autoSellAllPetsToggle then
                    pcall(function()
                        local state = autoSellAllPetsState or false
                        autoSellAllPetsToggle.Value = state
                        HatchGlobals.autoSellAllPets = state
                        -- log removed
                    end)
                end
                
                -- Update tier sell toggles
                for tier = 1, 5 do
                    local tierToggle = ConfigSystem.UIElements["PetTierSell_" .. tier]
                    if tierToggle then
                        pcall(function()
                            local state = HatchGlobals.petTierSellList[tier]
                            tierToggle.Value = state
                            -- log removed
                        end)
                    end
                end
                
                -- Start automation n·∫øu c·∫ßn
                if autoBuyState and not HatchGlobals.isAutoBuying then
                    -- log removed
                    startAutoBuy()
                elseif not autoBuyState and HatchGlobals.isAutoBuying then
                    -- log removed
                    HatchGlobals.isAutoBuying = false
                end
                
                if autoHatchState and not HatchGlobals.isAutoHatching then
                    -- log removed
                    startAutoHatch()
                elseif not autoHatchState and HatchGlobals.isAutoHatching then
                    -- log removed
                    HatchGlobals.isAutoHatching = false
                end
            end)
        else
            -- log removed
        end
    end
    

end

return Module
